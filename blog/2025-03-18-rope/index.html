<!DOCTYPE html><html lang="en"> <head><meta charset="utf-8"><link rel="icon" type="image/svg+xml" href="/favicon.ico"><meta name="viewport" content="width=device-width"><meta name="generator" content="Astro v5.10.1"><title>RoPE: Rotational Position Embedding - Academic Homepage</title><link rel="stylesheet" href="https://fred-wang.github.io/MathFonts/NewComputerModern/mathfonts.css"><link rel="stylesheet" href="/_astro/blog.CJoC8E46.css"></head> <body class="blog-post"> <!-- SEO Meta Tags --><title>Research Article - Xiaotian Han | Academic Insights</title><meta name="title" content="Research Article - Xiaotian Han | Academic Insights"><meta name="description" content="Academic research article by Xiaotian Han on machine learning and large language models."><meta name="keywords" content="research article, machine learning, large language models, academic research, LLM"><meta name="author" content="Xiaotian Han"><meta name="robots" content="index, follow"><meta name="language" content="en"><meta name="revisit-after" content="7 days"><!-- Canonical URL --><link rel="canonical" href="https://ahxt.github.io/blog/2025-03-18-rope/"><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:url" content="https://ahxt.github.io/blog/2025-03-18-rope/"><meta property="og:title" content="Research Article - Xiaotian Han | Academic Insights"><meta property="og:description" content="Academic research article by Xiaotian Han on machine learning and large language models."><meta property="og:image" content="https://ahxt.github.io//xt.png"><meta property="og:image:alt" content="Xiaotian Han - Profile Photo"><meta property="og:site_name" content="Xiaotian Han - Academic Homepage"><meta property="og:locale" content="en_US"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://ahxt.github.io/blog/2025-03-18-rope/"><meta property="twitter:title" content="Research Article - Xiaotian Han | Academic Insights"><meta property="twitter:description" content="Academic research article by Xiaotian Han on machine learning and large language models."><meta property="twitter:image" content="https://ahxt.github.io//xt.png"><meta property="twitter:image:alt" content="Xiaotian Han - Profile Photo"><meta property="twitter:creator" content="@XiaotianHan1"><!-- Additional Meta Tags for Academic Site --><meta name="theme-color" content="#1e40af"><meta name="msapplication-TileColor" content="#1e40af"><!-- Structured Data --><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","name":"Xiaotian Han","headline":"Research Article - Xiaotian Han | Academic Insights","jobTitle":"Assistant Professor of Computer Science","worksFor":{"@type":"Organization","name":"Case Western Reserve University","url":"https://case.edu"},"alumniOf":{"@type":"Organization","name":"Texas A&M University"},"knowsAbout":["Machine Learning","Large Language Models","Computer Science","Artificial Intelligence","LLMs"],"url":"https://ahxt.github.io/blog/2025-03-18-rope/","image":"https://ahxt.github.io//xt.png","sameAs":["https://scholar.google.com/citations?hl=en&user=Uromx98AAAAJ&view_op=list_works&sortby=pubdate","https://x.com/XiaotianHan1","https://bsky.app/profile/xhan2.bsky.social","https://github.com/ahxt"],"author":{"@type":"Person","name":"Xiaotian Han"},"publisher":{"@type":"Person","name":"Xiaotian Han"},"datePublished":"2025-06-28T03:59:49.022Z","dateModified":"2025-06-28T03:59:49.022Z","description":"Academic research article by Xiaotian Han on machine learning and large language models."}</script><!-- Preconnect to external domains for performance --><link rel="preconnect" href="https://scholar.google.com"><link rel="preconnect" href="https://github.com"><link rel="dns-prefetch" href="https://x.com"><link rel="dns-prefetch" href="https://bsky.app"><header> <nav> <div class="logo-container"> <h2 class="logo"> <a href="/" class="logo-link"> <span class="logo-text">Xiaotian Han</span> </a> </h2> </div> <div class="internal-links"> <a href="/" class="nav-link "> <span class="nav-text">About</span> <div class="nav-indicator"></div> </a> <a href="/blog" class="nav-link active"> <span class="nav-text">Blog</span> <div class="nav-indicator"></div> </a> </div> </nav> </header> <div class="footer" hidden="hidden"> <div class="center"> <a><img src="//clustrmaps.com/map_v2.png?cl=ffffff&w=a&t=m&d=91g_Uih-7fadH9madF_Vex1LQXOVlduL5aeBBSKXgXA&co=2d78ad&ct=ffffff"></a> </div> </div> <main> <div> <article> <div class="post-header"> <h4>RoPE: Rotational Position Embedding</h4> <div class="post-meta"> <div class="date"> March 17, 2025 </div> <div class="author">by Xiaotian Han</div> </div> </div> <div class="content"> <div>
  <div>1.Notation</div>
  <div>2.Motivations: We Pursue Relative Positional Embedding</div>
  <div>3.RoPE (Rotational Position Embedding)</div>
  <div>4.RoPE Implementation (Half-and-Half Pairing)</div>
  <div>5.Example:</div>
  <h2>1. Notation</h2>
  <table>
    <tr>
      <td><strong>Notation</strong></td>
      <td><strong>Description</strong></td>
    </tr>
    <tr>
      <td><span><math><msub><mi>𝒒</mi><mi>𝑚</mi></msub></math></span></td>
      <td><span><math><mi>𝑚</mi></math></span>-th query vector without positional information</td>
    </tr>
    <tr>
      <td><span><math><msub><mi>𝒌</mi><mi>𝑛</mi></msub></math></span></td>
      <td><span><math><mi>𝑛</mi></math></span>-th key vector without positional information</td>
    </tr>
    <tr>
      <td><span><math><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></math></span></td>
      <td><span><math><mi>𝑚</mi></math></span>-th query vector with positional information</td>
    </tr>
    <tr>
      <td><span><math><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></math></span></td>
      <td><span><math><mi>𝑛</mi></math></span>-th key vector with positional information</td>
    </tr>
  </table>
  <h2>2. Motivations: We Pursue Relative Positional Embedding</h2>
  <p>To incorporate positional information into the attention mechanism, we need to transform the original query and key vectors. The functions <span><math><mrow><mi>𝑓</mi><mrow><mo>(</mo><mrow><mrow><mo>⋅</mo><mo>,</mo></mrow><mo>⋅</mo></mrow><mo>)</mo></mrow></mrow></math></span> encode the position indices <span><math><mi>𝑚</mi></math></span> and <span><math><mi>𝑛</mi></math></span> into the query and key vectors respectively, resulting in position-aware representations <span><math><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></math></span> and <span><math><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></math></span>.</p>
  <math display="block"><mrow><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><mrow><mrow><mi>𝑓</mi><mrow><mo>(</mo><mrow><mrow><msub><mi>𝒒</mi><mi>𝑚</mi></msub><mo>,</mo></mrow><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>,</mo></mrow><mspace width="1em"></mspace><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><mrow><mi>𝑓</mi><mrow><mo>(</mo><mrow><mrow><msub><mi>𝒌</mi><mi>𝑛</mi></msub><mo>,</mo></mrow><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></math>
  <p>Typically, the attention score between a query at position <span><math><mi>𝑚</mi></math></span> and a key at position <span><math><mi>𝑛</mi></math></span> can be represented as a function <span><math><mi>𝑔</mi></math></span> that depends on both the content vectors (<span><math><msub><mi>𝒒</mi><mi>𝑚</mi></msub></math></span> and <span><math><msub><mi>𝒌</mi><mi>𝑛</mi></msub></math></span>) and their absolute positions (<span><math><mi>𝑚</mi></math></span> and <span><math><mi>𝑛</mi></math></span>) as follows:</p>
  <math display="block"><mrow><mrow><mtext>Attn</mtext><mrow><mo>(</mo><mrow><mrow><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>,</mo></mrow><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></mrow><mo>)</mo></mrow></mrow><mo>=</mo><mrow><mi>𝑔</mi><mrow><mo>(</mo><mrow><mrow><msub><mi>𝒒</mi><mi>𝑚</mi></msub><mo>,</mo></mrow><mrow><msub><mi>𝒌</mi><mi>𝑛</mi></msub><mo>,</mo></mrow><mrow><mi>𝑚</mi><mo>,</mo></mrow><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></math>
  <p>but we want the attention score to only depend on the relative position (<span><math><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow></math></span>) rather than absolute positions <span><math><mi>𝑚</mi></math></span> and <span><math><mi>𝑛</mi></math></span>, as relative position is easier to generalize to unseen sequence lengths.</p>
  <p><strong>Goal of relative positional embedding</strong>: Thus our goal is to find a function <span><math><mi>𝑔</mi></math></span> which is only a function of <span><math><msub><mi>𝒒</mi><mi>𝑚</mi></msub></math></span>, <span><math><msub><mi>𝒌</mi><mi>𝑛</mi></msub></math></span>, and <span><math><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow></math></span>, instead of <span><math><mi>𝑚</mi></math></span> and <span><math><mi>𝑛</mi></math></span> themselves as follows:</p>
  <math display="block"><mrow><mrow><mtext>Attn</mtext><mrow><mo>(</mo><mrow><mrow><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>,</mo></mrow><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></mrow><mo>)</mo></mrow></mrow><mo>=</mo><mrow><mi>𝑔</mi><mrow><mo>(</mo><mrow><mrow><msub><mi>𝒒</mi><mi>𝑚</mi></msub><mo>,</mo></mrow><mrow><msub><mi>𝒌</mi><mi>𝑛</mi></msub><mo>,</mo></mrow><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow></mrow><mo>)</mo></mrow></mrow></mrow></math>
  <p>The RoPE is a solution to this goal.</p>
  <h2>3. RoPE (Rotational Position Embedding)</h2>
  <p>RoPE is a positional embedding that is a function of the relative position <span><math><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow></math></span>, which rotates the query and key vectors and then computes the attention score, which is a function of the relative position <span><math><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow></math></span>.</p>
  <p>The base idea of RoPE is to rotate the query and key vectors by a certain angle, thus their dot product is a function of the relative position <span><math><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow></math></span>. RoPE used the property of rotation matrix multiplication. When we need to rotate a 2-dimensional vector <span><math><mrow><mo>(</mo><mtable><mtr><mtd><mi>𝑥</mi></mtd></mtr><mtr><mtd><mi>𝑦</mi></mtd></mtr></mtable><mo>)</mo></mrow></math></span> by an angle <span><math><mi>𝜃</mi></math></span>, we can multiply a rotation matrix <span><math><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mrow><mo>−</mo><mi mathvariant="normal">sin</mi></mrow><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mi mathvariant="normal">sin</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow></math></span> to the vector <span><math><mrow><mo>(</mo><mtable><mtr><mtd><mi>𝑥</mi></mtd></mtr><mtr><mtd><mi>𝑦</mi></mtd></mtr></mtable><mo>)</mo></mrow></math></span>, to get the rotated vector <span><math><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi>𝑥</mi><mi mathvariant="normal">cos</mi><mi>𝜃</mi><mo>−</mo><mi>𝑦</mi><mi mathvariant="normal">sin</mi><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mi>𝑥</mi><mi mathvariant="normal">sin</mi><mi>𝜃</mi><mo>+</mo><mi>𝑦</mi><mi mathvariant="normal">cos</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow></math></span>.</p>
  <p>In the following, suppose the query and key vectors are 2-dimensional vectors. We can rotate the query and key:</p>
  <math display="block"><mrow><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><mrow><mi>𝑓</mi><mrow><mo>(</mo><mrow><mrow><msub><mi>𝒒</mi><mi>𝑚</mi></msub><mo>,</mo></mrow><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mrow><mo>−</mo><mi mathvariant="normal">sin</mi></mrow><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mi mathvariant="normal">sin</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mrow></math><math display="block"><mrow><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><mrow><mi>𝑓</mi><mrow><mo>(</mo><mrow><mrow><msub><mi>𝒌</mi><mi>𝑛</mi></msub><mo>,</mo></mrow><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mrow><mo>−</mo><mi mathvariant="normal">sin</mi></mrow><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mi mathvariant="normal">sin</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mrow></math>
  <p>The attention score is then:</p>
  <math display="block"><mtable><mtr><mtd class="mathyml-align-right"><mrow><mtext>Attn</mtext><mrow><mo>(</mo><mrow><mrow><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>,</mo></mrow><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></mrow><mo>)</mo></mrow></mrow></mtd><mtd class="mathyml-align-left"><mo>=</mo><msubsup><mi>𝒒</mi><mi>𝑚</mi><mrow><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo><mi>𝑇</mi></mrow></msubsup><mo>⋅</mo><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mo>=</mo><msup><mrow><mo>[</mo><mrow><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mrow><mo>−</mo><mi mathvariant="normal">sin</mi></mrow><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mi mathvariant="normal">sin</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mrow><mo>]</mo></mrow><mi>𝑇</mi></msup><mo>⋅</mo><mrow><mo>[</mo><mrow><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mrow><mo>−</mo><mi mathvariant="normal">sin</mi></mrow><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mi mathvariant="normal">sin</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mrow><mo>]</mo></mrow></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup></mtd><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow><mrow><mo>[</mo><mrow><msup><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mrow><mo>−</mo><mi mathvariant="normal">sin</mi></mrow><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mi mathvariant="normal">sin</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow><mi>𝑇</mi></msup><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mrow><mo>−</mo><mi mathvariant="normal">sin</mi></mrow><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mi mathvariant="normal">sin</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow></mrow><mo>]</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup></mtd><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow><mrow><mo>[</mo><mrow><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">sin</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mrow><mo>−</mo><mi mathvariant="normal">sin</mi></mrow><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑚</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mrow><mo>−</mo><mi mathvariant="normal">sin</mi></mrow><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd></mtr><mtr><mtd><mrow><mi mathvariant="normal">sin</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mi>𝑛</mi><mi>𝜃</mi></mrow></mtd></mtr></mtable><mo>)</mo></mrow></mrow><mo>]</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup></mtd><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow></mtd><mtd><mrow><mo>−</mo><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow></mtd><mtd><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow></mtd></mtr></mtable><mo>)</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mo>=</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup><mrow><mo>[</mo><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow><mo>−</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow><mo>]</mo></mrow></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mspace width="1em"></mspace><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup><mrow><mo>[</mo><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow><mo>+</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow><mo>]</mo></mrow></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mo>=</mo><mrow><mo>(</mo><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup></mrow><mo>)</mo></mrow><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><mrow><mo>(</mo><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mo>−</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup></mrow><mo>)</mo></mrow><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mo>=</mo><mrow><mi>𝑔</mi><mrow><mo>(</mo><mrow><mrow><msub><mi>𝒒</mi><mi>𝑚</mi></msub><mo>,</mo></mrow><mrow><msub><mi>𝒌</mi><mi>𝑛</mi></msub><mo>,</mo></mrow><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow></mrow><mo>)</mo></mrow></mrow></mtd></mtr></mtable></math>
  <p>thus we have shown that the attention score is a function of <span><math><msub><mi>𝒌</mi><mi>𝑛</mi></msub></math></span>, <span><math><msub><mi>𝒒</mi><mi>𝑚</mi></msub></math></span>, and their relative position <span><math><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow></math></span>, not the absolute positions <span><math><mi>𝑚</mi></math></span> and <span><math><mi>𝑛</mi></math></span> themselves.</p>
  <h2>4. RoPE Implementation (Half-and-Half Pairing)</h2>
  <p>This is the method used in your Python code and in many popular implementations like LLaMA. It is chosen for its extreme efficiency with vectorized operations. Instead of pairing adjacent dimensions (which is intuitive), this method pairs the <strong>first half of the dimensions with the second half</strong>.</p>
  <p>For a vector <span><math><mi>𝒒</mi></math></span> with dim<span><math><mrow><mo>=</mo><mi>𝑑</mi></mrow></math></span>:</p>
  <ul>
    <li><strong>Pair 0:</strong> dimension <span><math><mn>0</mn></math></span> is paired with dimension <span><math><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></math></span>. <span><math><mrow><mo>(</mo><mrow><mrow><msup><mi>𝑞</mi><mn>0</mn></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msup></mrow><mo>)</mo></mrow></math></span></li>
    <li><strong>Pair 1:</strong> dimension <span><math><mn>1</mn></math></span> is paired with dimension <span><math><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></math></span>. <span><math><mrow><mo>(</mo><mrow><mrow><msup><mi>𝑞</mi><mn>1</mn></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msup></mrow><mo>)</mo></mrow></math></span></li>
    <li>…</li>
    <li><strong>Pair <span><math><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></math></span>:</strong> dimension <span><math><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></math></span> is paired with dimension <span><math><mrow><mi>𝑑</mi><mo>−</mo><mn>1</mn></mrow></math></span>. <span><math><mrow><mo>(</mo><mrow><mrow><msup><mi>𝑞</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mrow><mi>𝑑</mi><mo>−</mo><mn>1</mn></mrow></msup></mrow><mo>)</mo></mrow></math></span></li>
  </ul>
  <p>In practice, the query and key vectors are not 2-dimensional vectors, but <span><math><mi>𝑑</mi></math></span>-dimensional vectors (<span><math><mrow><mi>𝑑</mi><mo>%</mo><mn>2</mn><mo>=</mo><mn>0</mn></mrow></math></span>).</p>
  <math display="block"><mrow><msub><mi>𝒒</mi><mi>𝑚</mi></msub><mo>=</mo><mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mi>𝑑</mi></msubsup></mtd></mtr></mtable><mo>)</mo></mrow><mo>,</mo></mrow><mspace width="1em"></mspace><msub><mi>𝒌</mi><mi>𝑛</mi></msub><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑛</mi><mi>𝑑</mi></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mrow></math>
  <p>we then group the query and key vectors into <span><math><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></math></span> pairs, and rotate each pair by a different angle <span><math><msub><mi>𝜃</mi><mi>𝑖</mi></msub></math></span> (<span><math><mrow><mi>𝑖</mi><mo>=</mo><mn>1</mn><mo>,</mo><mn>2</mn><mo>,</mo><mo>…</mo><mo>,</mo><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></mrow></math></span>). Usually we make the following pairs: <span><math><mrow><mrow><mo>[</mo><mrow><mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>0</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup></mtd></mtr></mtable><mo>)</mo></mrow><mo>,</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑚</mi><mn>0</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑚</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mrow><mo>]</mo></mrow><mo>,</mo><mrow><mo>[</mo><mrow><mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup></mtd></mtr></mtable><mo>)</mo></mrow><mo>,</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑚</mi><mn>1</mn></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mrow><mo>]</mo></mrow><mo>,</mo><mrow><mo>…</mo><mo>,</mo></mrow><mrow><mo>[</mo><mrow><mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mi>𝑑</mi><mo>−</mo><mn>1</mn></mrow></msubsup></mtd></mtr></mtable><mo>)</mo></mrow><mo>,</mo></mrow><mrow><mo>(</mo><mtable><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></msubsup></mtd></mtr><mtr><mtd><msubsup><mi>𝑘</mi><mi>𝑚</mi><mrow><mi>𝑑</mi><mo>−</mo><mn>1</mn></mrow></msubsup></mtd></mtr></mtable><mo>)</mo></mrow></mrow><mo>]</mo></mrow></mrow></math></span>.</p>
  <p>For each pair <span><math><mi>𝑖</mi></math></span> (<span><math><mrow><mi>𝑖</mi><mo>=</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo>,</mo><mo>…</mo><mo>,</mo><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></math></span>), we rotate by an angle <span><math><mrow><msup><mi>𝜃</mi><mi>𝑖</mi></msup><mo>=</mo><mfrac><mn>1</mn><msup><mi>𝜔</mi><mfrac><mrow><mn>2</mn><mi>𝑖</mi></mrow><mi>𝑑</mi></mfrac></msup></mfrac><mo>=</mo><mfrac><mn>1</mn><msup><mn>10000</mn><mfrac><mrow><mn>2</mn><mi>𝑖</mi></mrow><mi>𝑑</mi></mfrac></msup></mfrac></mrow></math></span>, where <span><math><mi>𝜔</mi></math></span> is a base frequency (typically <span><math><mn>10000</mn></math></span>), <span><math><mi>𝑖</mi></math></span> is the <span><math><mi>𝑖</mi></math></span>-th dimension <span><math><mrow><mi>𝑖</mi><mo>∈</mo><mrow><mo>[</mo><mrow><mrow><mn>0</mn><mo>,</mo></mrow><mrow><mn>1</mn><mo>,</mo></mrow><mrow><mn>2</mn><mo>,</mo></mrow><mrow><mo>…</mo><mo>,</mo></mrow><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></mrow><mo>]</mo></mrow></mrow></math></span>, and <span><math><mi>𝑑</mi></math></span> is the dimension of the query and key vectors.</p>
  <p>This means higher dimensions get rotated by larger angles, creating a spectrum of different frequencies in the positional encoding.</p>
  <p>The rotated query vector becomes:</p>
  <math display="block"><mrow><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>2</mn></mrow></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mi>𝑑</mi></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>2</mn></mrow></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mi>𝑑</mi></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr></mtable><mo>)</mo></mrow><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>2</mn></mrow></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mi>𝑑</mi></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>2</mn></mrow></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>2</mn></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mi>𝑑</mi></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑚</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr></mtable><mo>)</mo></mrow></mrow></math>
  <p>Similarly for the key vector:</p>
  <math display="block"><mrow><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>2</mn></mrow></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mi>𝑑</mi></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>2</mn></mrow></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mi>𝑑</mi></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr></mtable><mo>)</mo></mrow><mo>=</mo><mrow><mo>(</mo><mtable><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>2</mn></mrow></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>−</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mi>𝑑</mi></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>1</mn></mrow></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>+</mo><mn>2</mn></mrow></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>2</mn></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mn>2</mn><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr><mtr><mtd><mo>⋮</mo></mtd></mtr><mtr><mtd><mrow><msubsup><mi>𝑘</mi><mi>𝑛</mi><mi>𝑑</mi></msubsup><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow><mo>+</mo><msubsup><mi>𝑘</mi><mi>𝑛</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><msup><mi>𝜃</mi><mfrac><mrow><mi>𝑑</mi><mo>−</mo><mn>2</mn></mrow><mi>𝑑</mi></mfrac></msup><mi>𝑛</mi></mrow><mo>)</mo></mrow></mrow></mrow></mtd></mtr></mtable><mo>)</mo></mrow></mrow></math>
  <p>When we compute the attention score between these rotated vectors, each pair contributes a term that depends on the relative position <span><math><mrow><mo>(</mo><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow><mo>)</mo></mrow></math></span>, similar to the 2D case we analyzed earlier. The different frequencies <span><math><msup><mi>𝜔</mi><mrow><mn>2</mn><mfrac><mi>𝑖</mi><mi>𝑑</mi></mfrac></mrow></msup></math></span> allow the model to capture position-dependent patterns at different scales.</p>
  <p>Thus we have:</p>
  <p><span><math><mtable><mtr><mtd class="mathyml-align-right"><msubsup><mi>𝒒</mi><mi>𝑚</mi><mrow><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo><mi>𝑇</mi></mrow></msubsup><mo>⋅</mo><msubsup><mi>𝒌</mi><mi>𝑛</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></mtd><mtd class="mathyml-align-left"><mo>=</mo><mrow><mo>[</mo><mrow><mrow><mo>(</mo><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup></mrow><mo>)</mo></mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow><mo>+</mo><mrow><mo>(</mo><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mn>1</mn></msubsup><mo>−</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mn>1</mn></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mfrac><mi>𝑑</mi><mn>2</mn></mfrac></msubsup></mrow><mo>)</mo></mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow><mo>]</mo></mrow><mo>+</mo></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mo>…</mo><mo>+</mo><mrow><mo>[</mo><mrow><mrow><mo>(</mo><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></msubsup><mo>+</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mi>𝑑</mi><mo>−</mo><mn>1</mn></mrow></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mi>𝑑</mi><mo>−</mo><mn>1</mn></mrow></msubsup></mrow><mo>)</mo></mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow><mo>+</mo><mrow><mo>(</mo><mrow><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mi>𝑑</mi><mo>−</mo><mn>1</mn></mrow></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></msubsup><mo>−</mo><msubsup><mi>𝑞</mi><mi>𝑚</mi><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>−</mo><mn>1</mn></mrow></msubsup><msubsup><mi>𝑘</mi><mi>𝑛</mi><mrow><mi>𝑑</mi><mo>−</mo><mn>1</mn></mrow></msubsup></mrow><mo>)</mo></mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><mrow><mrow><mo>(</mo><mrow><mi>𝑛</mi><mo>−</mo><mi>𝑚</mi></mrow><mo>)</mo></mrow><mi>𝜃</mi></mrow><mo>)</mo></mrow></mrow><mo>]</mo></mrow></mtd></mtr><mtr><mtd class="mathyml-align-right"></mtd><mtd class="mathyml-align-left"><mo>=</mo><mrow><mi>𝑔</mi><mrow><mo>(</mo><mrow><mrow><msub><mi>𝒒</mi><mi>𝑚</mi></msub><mo>,</mo></mrow><mrow><msub><mi>𝒌</mi><mi>𝑛</mi></msub><mo>,</mo></mrow><mrow><mi>𝑚</mi><mo>−</mo><mi>𝑛</mi></mrow></mrow><mo>)</mo></mrow></mrow></mtd></mtr></mtable></math></span></p>
  <h2>5. Example:</h2>
  <p>Let's walk through how the code achieves this with a concrete example where dim <span><math><mrow><mo>=</mo><mn>8</mn></mrow></math></span>. The input query vector is <span><math><mrow><mi>𝒒</mi><mo>=</mo><mrow><mo>[</mo><mrow><mrow><msup><mi>𝑞</mi><mn>0</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>1</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>2</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>3</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>4</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>5</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>6</mn></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mn>7</mn></msup></mrow><mo>]</mo></mrow></mrow></math></span>.</p>
  <p><strong>Pairing</strong>: The pairs will be: <span><math><mrow><mrow><mo>(</mo><mrow><mrow><msup><mi>𝑞</mi><mn>0</mn></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mn>4</mn></msup></mrow><mo>)</mo></mrow><mo>,</mo><mrow><mo>(</mo><mrow><mrow><msup><mi>𝑞</mi><mn>1</mn></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mn>5</mn></msup></mrow><mo>)</mo></mrow><mo>,</mo><mrow><mo>(</mo><mrow><mrow><msup><mi>𝑞</mi><mn>2</mn></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mn>6</mn></msup></mrow><mo>)</mo></mrow><mo>,</mo><mrow><mo>(</mo><mrow><mrow><msup><mi>𝑞</mi><mn>3</mn></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mn>7</mn></msup></mrow><mo>)</mo></mrow></mrow></math></span>.</p>
  <p><strong>Frequency</strong>: There will be <span><math><mrow><mfrac><mi>𝑑</mi><mn>2</mn></mfrac><mo>=</mo><mn>4</mn></mrow></math></span> unique angles for a given position <span><math><mi>𝑚</mi></math></span>: <span><math><mrow><mrow><msup><mi>𝜃</mi><mn>0</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝜃</mi><mn>1</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝜃</mi><mn>2</mn></msup><mo>,</mo></mrow><msup><mi>𝜃</mi><mn>3</mn></msup></mrow></math></span>. These angles are calculated based on the position <span><math><mi>𝑚</mi></math></span> and the pair index <span><math><mrow><mi>𝑖</mi><mo>∈</mo><mrow><mo>[</mo><mrow><mrow><mn>0</mn><mo>,</mo></mrow><mrow><mn>1</mn><mo>,</mo></mrow><mrow><mn>2</mn><mo>,</mo></mrow><mn>3</mn></mrow><mo>]</mo></mrow></mrow></math></span>:</p>
  <math display="block"><mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mi>𝑖</mi></msubsup><mo>=</mo><mfrac><mn>1</mn><msup><mn>10000</mn><mfrac><mrow><mn>2</mn><mi>𝑖</mi></mrow><mi>𝑑</mi></mfrac></msup></mfrac><mo>⋅</mo><mi>𝑚</mi></mrow></math>
  <p>where <span><math><mi>𝑑</mi></math></span> is the dimension. For example, <span><math><mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>=</mo><mfrac><mn>1</mn><msup><mn>10000</mn><mfrac><mrow><mn>2</mn><mo>∗</mo><mn>0</mn></mrow><mn>8</mn></mfrac></msup></mfrac><mo>⋅</mo><mi>𝑚</mi><mo>=</mo><mfrac><mn>1</mn><msup><mn>10000</mn><mn>0</mn></msup></mfrac><mo>⋅</mo><mi>𝑚</mi><mo>=</mo><mn>1</mn><mo>⋅</mo><mi>𝑚</mi><mo>=</mo><mi>𝑚</mi></mrow></math></span></p>
  <p>We construct the angles for a given position <span><math><mi>𝑚</mi></math></span> as <span><math><mrow><mo>[</mo><mrow><mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>,</mo></mrow><mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>,</mo></mrow><mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>,</mo></mrow><mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup><mo>,</mo></mrow><mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>,</mo></mrow><mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>,</mo></mrow><mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>,</mo></mrow><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup></mrow><mo>]</mo></mrow></math></span>.</p>
  <p>The final <code>cos</code> and <code>sin</code> tensors will therefore have this duplicated structure. For position <code>m</code>:</p>
  <p><span><math><mrow><msub><mi mathvariant="normal">cos</mi><mi>𝑚</mi></msub><mo>=</mo><mrow><mo>[</mo><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup><mo>)</mo></mrow></mrow><mo>]</mo></mrow></mrow></math></span></p>
  <p><span><math><mrow><msub><mi mathvariant="normal">sin</mi><mi>𝑚</mi></msub><mo>=</mo><mrow><mo>[</mo><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>)</mo></mrow><mo>,</mo><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup><mo>)</mo></mrow></mrow><mo>]</mo></mrow></mrow></math></span></p>
  <p>Now, let's see how the rotation is applied to <span><math><mrow><mi>𝒒</mi><mo>=</mo><mrow><mo>[</mo><mrow><mrow><msup><mi>𝑞</mi><mn>0</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>1</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>2</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>3</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>4</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>5</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>6</mn></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mn>7</mn></msup></mrow><mo>]</mo></mrow></mrow></math></span>.</p>
  <p>We construct half-rotated query vector as <span><math><mrow><msub><mi>𝒒</mi><mtext>rotated </mtext></msub><mo>=</mo><mrow><mo>[</mo><mrow><mrow><mo>−</mo><msup><mi>𝑞</mi><mn>4</mn></msup><mo>,</mo></mrow><mrow><mo>−</mo><msup><mi>𝑞</mi><mn>5</mn></msup><mo>,</mo></mrow><mrow><mo>−</mo><msup><mi>𝑞</mi><mn>6</mn></msup><mo>,</mo></mrow><mrow><mo>−</mo><msup><mi>𝑞</mi><mn>7</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>0</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>1</mn></msup><mo>,</mo></mrow><mrow><msup><mi>𝑞</mi><mn>2</mn></msup><mo>,</mo></mrow><msup><mi>𝑞</mi><mn>3</mn></msup></mrow><mo>]</mo></mrow></mrow></math></span>.</p>
  <p>We then construct the query vector <span><math><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup></math></span> as:</p>
  <p><span><math><mrow><msubsup><mi>𝒒</mi><mi>𝑚</mi><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><mrow><mo>(</mo><mrow><mi>𝒒</mi><mo>⊙</mo><mi mathvariant="normal">cos</mi></mrow><mo>)</mo></mrow><mo>+</mo><mrow><mo>(</mo><mrow><msub><mi>𝒒</mi><mtext>rotated </mtext></msub><mo>⊙</mo><mi mathvariant="normal">sin</mi></mrow><mo>)</mo></mrow></mrow></math></span></p>
  <p>If we let our 2D vector be <span><math><mrow><mo>(</mo><mrow><mrow><msub><mi>𝑞</mi><mn>0</mn></msub><mo>,</mo></mrow><msub><mi>𝑞</mi><mn>4</mn></msub></mrow><mo>)</mo></mrow></math></span> and the rotation angle be <span><math><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup></math></span>, the standard 2D rotation formulas are:</p>
  <ul>
    <li><span><math><mrow><msubsup><mi>𝑞</mi><mn>0</mn><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><msub><mi>𝑞</mi><mn>0</mn></msub><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>)</mo></mrow></mrow><mo>−</mo><msub><mi>𝑞</mi><mn>4</mn></msub><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>)</mo></mrow></mrow></mrow></math></span></li>
    <li><span><math><mrow><msubsup><mi>𝑞</mi><mn>4</mn><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><msub><mi>𝑞</mi><mn>0</mn></msub><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>)</mo></mrow></mrow><mo>+</mo><msub><mi>𝑞</mi><mn>4</mn></msub><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>0</mn></msubsup><mo>)</mo></mrow></mrow></mrow></math></span></li>
  </ul>
  <p>As you can see, the code perfectly implements the 2D rotation for the pair <span><math><mrow><mo>(</mo><mrow><mrow><msub><mi>𝑞</mi><mn>0</mn></msub><mo>,</mo></mrow><msub><mi>𝑞</mi><mn>4</mn></msub></mrow><mo>)</mo></mrow></math></span>. This same logic applies simultaneously to all other pairs: <span><math><mrow><mo>(</mo><mrow><mrow><msub><mi>𝑞</mi><mn>1</mn></msub><mo>,</mo></mrow><msub><mi>𝑞</mi><mn>5</mn></msub></mrow><mo>)</mo></mrow></math></span>, <span><math><mrow><mo>(</mo><mrow><mrow><msub><mi>𝑞</mi><mn>2</mn></msub><mo>,</mo></mrow><msub><mi>𝑞</mi><mn>6</mn></msub></mrow><mo>)</mo></mrow></math></span>, <span><math><mrow><mo>(</mo><mrow><mrow><msub><mi>𝑞</mi><mn>3</mn></msub><mo>,</mo></mrow><msub><mi>𝑞</mi><mn>7</mn></msub></mrow><mo>)</mo></mrow></math></span>.</p>
  <ul>
    <li><span><math><mrow><msubsup><mi>𝑞</mi><mn>1</mn><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><msub><mi>𝑞</mi><mn>1</mn></msub><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>)</mo></mrow></mrow><mo>−</mo><msub><mi>𝑞</mi><mn>5</mn></msub><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>)</mo></mrow></mrow></mrow></math></span></li>
    <li><span><math><mrow><msubsup><mi>𝑞</mi><mn>5</mn><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><msub><mi>𝑞</mi><mn>1</mn></msub><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>)</mo></mrow></mrow><mo>+</mo><msub><mi>𝑞</mi><mn>5</mn></msub><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>1</mn></msubsup><mo>)</mo></mrow></mrow></mrow></math></span></li>
    <li><span><math><mrow><msubsup><mi>𝑞</mi><mn>2</mn><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><msub><mi>𝑞</mi><mn>2</mn></msub><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>)</mo></mrow></mrow><mo>−</mo><msub><mi>𝑞</mi><mn>6</mn></msub><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>)</mo></mrow></mrow></mrow></math></span></li>
    <li><span><math><mrow><msubsup><mi>𝑞</mi><mn>6</mn><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><msub><mi>𝑞</mi><mn>2</mn></msub><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>)</mo></mrow></mrow><mo>+</mo><msub><mi>𝑞</mi><mn>6</mn></msub><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>2</mn></msubsup><mo>)</mo></mrow></mrow></mrow></math></span></li>
    <li><span><math><mrow><msubsup><mi>𝑞</mi><mn>3</mn><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><msub><mi>𝑞</mi><mn>3</mn></msub><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup><mo>)</mo></mrow></mrow><mo>−</mo><msub><mi>𝑞</mi><mn>7</mn></msub><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup><mo>)</mo></mrow></mrow></mrow></math></span></li>
    <li><span><math><mrow><msubsup><mi>𝑞</mi><mn>7</mn><mo lspace="0em" rspace="0em" style="padding-left: 0.08em">′</mo></msubsup><mo>=</mo><msub><mi>𝑞</mi><mn>3</mn></msub><mrow><mi mathvariant="normal">sin</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup><mo>)</mo></mrow></mrow><mo>+</mo><msub><mi>𝑞</mi><mn>7</mn></msub><mrow><mi mathvariant="normal">cos</mi><mrow><mo>(</mo><msubsup><mi>𝜃</mi><mi>𝑚</mi><mn>3</mn></msubsup><mo>)</mo></mrow></mrow></mrow></math></span></li>
  </ul>
</div>
 </div> <footer> <a href="/blog" class="back-link">← Back to Blog</a> </footer> </article> </div> </main> </body></html>